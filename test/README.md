# E2E Tests Setup

This directory contains end-to-end tests for the NestJS application.

## Database Configuration

For e2e tests, you have two options for database management:

### Option 1: Separate Test Database (Recommended)

Use a separate test database to avoid affecting your development database:

1. Create a test database in PostgreSQL:
   ```sql
   CREATE DATABASE yuchi_test;
   ```

2. Set the `DATABASE_URL_TEST` environment variable:
   ```bash
   export DATABASE_URL_TEST="postgresql://user:password@localhost:5432/yuchi_test"
   ```

3. Run Prisma migrations on the test database:
   ```bash
   DATABASE_URL=$DATABASE_URL_TEST pnpm prisma db push
   ```

### Option 2: Use Development Database

If you prefer to use the same database (not recommended for CI/CD):

1. The tests will use `DATABASE_URL` if `DATABASE_URL_TEST` is not set
2. **Warning**: Tests will clean the database before and after running, so all data will be deleted!

## Environment Variables

Create a `.env.test` file or set these environment variables:

```bash
# Database (use test database URL)
DATABASE_URL_TEST=postgresql://user:password@localhost:5432/yuchi_test
# Or use regular DATABASE_URL if not using separate test DB
DATABASE_URL=postgresql://user:password@localhost:5432/yuchi_dev

# Redis (can use same as dev or a test instance)
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT Configuration
JWT_SECRET=test-jwt-secret-key
JWT_EXPIRED_TIME=1h
JWT_REFRESH_SECRET=test-refresh-secret-key
JWT_REFRESH_EXPIRED_TIME=7d

# Cookie Secret
COOKIE_SECRET=test-cookie-secret

# Google OAuth (can be dummy values for tests)
GOOGLE_CLIENT_ID=test-client-id
GOOGLE_CLIENT_SECRET=test-client-secret

# Throttler (optional, defaults provided)
THROTTLE_LIMIT=100
THROTTLE_TTL=60
```

## Running Tests

```bash
# Run all e2e tests
pnpm test:e2e

# Run specific test file
pnpm test:e2e sync.e2e-spec.ts

# Run with coverage
pnpm test:cov
```

## Test Structure

- `jest-e2e.json` - Jest configuration for e2e tests
- `setup-e2e.ts` - Global setup/teardown for all tests
- `helpers/` - Test utilities:
  - `database.helper.ts` - Database operations (clean, seed, etc.)
  - `auth.helper.ts` - JWT token generation for authenticated requests
- `*.e2e-spec.ts` - Test files for each module

## Writing Tests

Example test structure:

```typescript
import { Test, TestingModule } from '@nestjs/testing'
import { INestApplication } from '@nestjs/common'
import * as request from 'supertest'
import { AppModule } from '../src/app.module'
import { DatabaseHelper } from './helpers/database.helper'
import { AuthHelper } from './helpers/auth.helper'

describe('YourController (e2e)', () => {
  let app: INestApplication
  let dbHelper: DatabaseHelper
  let authHelper: AuthHelper

  beforeAll(async () => {
    dbHelper = new DatabaseHelper()
    authHelper = new AuthHelper()
    await dbHelper.cleanDatabase()
    
    // Create test data...
    
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile()

    app = moduleFixture.createNestApplication()
    await app.init()
  })

  afterAll(async () => {
    await dbHelper.cleanDatabase()
    await dbHelper.disconnect()
    await app.close()
  })

  it('should do something', async () => {
    // Your test here
  })
})
```

## Database Cleanup

Tests automatically clean the database:
- **Before all tests**: Database is cleaned in `beforeAll`
- **After all tests**: Database is cleaned in `afterAll`

This ensures a clean state for each test run. If you need to clean between individual tests, use `beforeEach` or `afterEach` hooks.

## Notes

- Tests use the actual application modules, so they test the full integration
- Authentication is handled via JWT tokens generated by `AuthHelper`
- Database operations use Prisma with proper transaction handling
- All tests run sequentially (`--runInBand`) to avoid database conflicts
