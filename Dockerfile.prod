FROM node:22-alpine

RUN apk add --no-cache libc6-compat tini
RUN npm install -g pnpm

WORKDIR /app

# Copy dependency files and configuration
COPY package.json pnpm-lock.yaml .npmrc ./

# Install dependencies (unoptimized - includes devDeps for build)
RUN pnpm install

# Copy source code
COPY . .

# Generate Prisma and build
RUN pnpm prisma generate
RUN pnpm build

ENV NODE_ENV=production
EXPOSE 8888

ENTRYPOINT ["/sbin/tini", "--"]
CMD ["node", "dist/main.js"]
