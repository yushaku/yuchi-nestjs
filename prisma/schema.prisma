// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum PlanType {
  FREE
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  LIFETIME
}

enum SubStatus {
  ACTIVE
  EXPIRED
  CANCELED // User h·ªßy gia h·∫°n nh∆∞ng v·∫´n c√≤n h·∫°n d√πng
  GRACE_PERIOD // Apple/Google ƒëang th·ª≠ charge l·∫°i ti·ªÅn
}

enum CodeStatus {
  UNUSED // Ch∆∞a s·ª≠ d·ª•ng
  USED // ƒê√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng
}

enum SubscriptionSource {
  CODE
  GOOGLE_PLAY
  APPLE
}

enum Role {
  ADMIN // Qu·∫£n tr·ªã vi√™n - to√†n quy·ªÅn
  SALE // Nh√¢n vi√™n b√°n h√†ng - c√≥ th·ªÉ t·∫°o v√† qu·∫£n l√Ω subscription code
  MEMBER // Th√†nh vi√™n th∆∞·ªùng - user b√¨nh th∆∞·ªùng
}

model User {
  id             String             @id @default(uuid())
  email          String             @unique
  name           String?
  password       String
  role           Role               @default(MEMBER) // Ph√¢n quy·ªÅn: ADMIN, SALE, MEMBER
  wordProgresses UserWordProgress[]
  subscriptions  Subscription[]

  @@index([role]) // Index ƒë·ªÉ query user theo role
}

// ============================================
// TOPIK Vocabulary Learning Models
// ============================================
// Note: TOPIK levels are defined as constants in src/shared/constant.ts
// Valid levels: 1 (Beginner), 2 (Intermediate), 3 (Advanced)

model LearningGroup {
  id         String     @id @default(uuid())
  name       String // "Ch√†o h·ªèi & Th√¥ng tin c√° nh√¢n"
  icon       String? // "üëã"
  order      Int        @default(0)
  topikLevel Int // 1, 2, or 3 (references TOPIK_LEVEL enum in constant.ts)
  categories Category[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([topikLevel])
}

model Category {
  id          String         @id @default(uuid())
  name        String // "Ïù∏ÏÇ¨ (Ch√†o h·ªèi)"
  description String?
  icon        String? // "üëã"
  order       Int            @default(0)
  topikLevel  Int? // 1, 2, or 3 (references TOPIK_LEVEL enum in constant.ts)
  group       LearningGroup? @relation(fields: [groupId], references: [id])
  groupId     String?
  words       Vocabulary[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([topikLevel])
  @@index([groupId])
}

model Vocabulary {
  id                 String             @id @default(uuid())
  korean             String // "ÏïàÎÖïÌïòÏÑ∏Ïöî"
  hanja              String? // Hanja characters
  vietnamese         String // "Xin ch√†o"
  pronunciation      String // "annyeonghaseyo"
  example            String? // Korean example sentence
  exampleTranslation String? // Vietnamese translation of example
  category           Category           @relation(fields: [categoryId], references: [id])
  categoryId         String
  quizQuestions      QuizQuestion[]
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  userWordProgresses UserWordProgress[]

  @@index([categoryId])
  @@index([korean])
}

model QuizQuestion {
  id                  String     @id @default(uuid())
  question            String // Korean question
  questionTranslation String? // Vietnamese translation
  options             String[] // Array of options
  correctAnswer       String // Correct answer
  explanation         String? // Explanation in Vietnamese
  Vocabulary          Vocabulary @relation(fields: [VocabularyId], references: [id])
  VocabularyId        String
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  @@index([VocabularyId])
}

model UserWordProgress {
  userId  String
  vocabId String

  // Core SRS Data - Only fields needed for calculation
  reviewLevel Int     @default(0) @db.SmallInt // 0-4: Maps to ReviewLevel enum (level1-level5)
  isIgnored   Boolean @default(false) // Filter words from review

  // Review Tracking - Required for SRS calculation
  lastReviewed  DateTime @default(now()) // Th·ªùi ƒëi·ªÉm √¥n t·∫≠p l·∫ßn cu·ªëi (used to calculate nextReview)
  nextReview    DateTime // Quan tr·ªçng nh·∫•t ƒë·ªÉ query "Th·ªùi ƒëi·ªÉm v√†ng" (calculated from reviewLevel)
  correctCount  Int      @default(0) // S·ªë l·∫ßn tr·∫£ l·ªùi ƒë√∫ng (used for level progression)
  totalAttempts Int      @default(0) // T·ªïng s·ªë l·∫ßn th·ª≠ (used for statistics)

  // Quan h·ªá
  user  User       @relation(fields: [userId], references: [id])
  vocab Vocabulary @relation(fields: [vocabId], references: [id])

  // KEY T·ªêI ∆ØU 1: Composite Primary Key
  // ƒê·∫£m b·∫£o t√≠nh duy nh·∫•t + T·ª± ƒë·ªông t·∫°o Index cho c·∫∑p n√†y
  @@id([userId, vocabId])
  // KEY T·ªêI ∆ØU 2: Index cho truy v·∫•n SRS
  // Gi√∫p query: "L·∫•y nh·ªØng t·ª´ c·ªßa user X c·∫ßn √¥n tr∆∞·ªõc gi·ªù Y" c·ª±c nhanh
  @@index([userId, nextReview])
}

// ============================================
// Subscription Models
// ============================================

model SubscriptionCode {
  id        String     @id @default(uuid())
  code      String     @unique // M√£ code duy nh·∫•t (v√≠ d·ª•: "PROMO2024ABC")
  planType  PlanType // Lo·∫°i plan: MONTHLY, YEARLY, LIFETIME
  status    CodeStatus @default(UNUSED)
  expiresAt DateTime? // Ng√†y h·∫øt h·∫°n code (null = kh√¥ng gi·ªõi h·∫°n)
  usedAt    DateTime? // Th·ªùi ƒëi·ªÉm code ƒë∆∞·ª£c s·ª≠ d·ª•ng
  usedBy    String? // userId ƒë√£ s·ª≠ d·ª•ng code n√†y
  note      String? // Ghi ch√∫ c·ªßa nh√¢n vi√™n khi t·∫°o code
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Quan h·ªá
  subscription Subscription? // Subscription ƒë∆∞·ª£c t·∫°o t·ª´ code n√†y

  @@index([code]) // Index ƒë·ªÉ t√¨m code nhanh
  @@index([usedBy]) // Index ƒë·ªÉ query code ƒë√£ d√πng b·ªüi user n√†o
}

model Subscription {
  id        String             @id @default(uuid())
  userId    String
  planType  PlanType
  status    SubStatus          @default(ACTIVE)
  source    SubscriptionSource @default(CODE)
  startDate DateTime           @default(now())
  endDate   DateTime?
  codeId    String?            @unique

  // Google Play
  googlePlayPurchaseToken  String?
  googlePlaySubscriptionId String?
  googlePlayOrderId        String?

  // Apple App Store
  appleOriginalTransactionId String?
  appleProductId             String?
  appleReceiptData           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User              @relation(fields: [userId], references: [id])
  code SubscriptionCode? @relation(fields: [codeId], references: [id])

  @@index([userId])
  @@index([source])
  @@index([googlePlayPurchaseToken])
  @@index([appleOriginalTransactionId])
}
